name: Astronomer CI - Deploy code

on:
 push:
   branches:
     - main

env:
 ## Sets Deployment API credentials as environment variables
 ASTRO_API_TOKEN: ${{ secrets.ASTRO_API_TOKEN }}

jobs:
 build:
   runs-on: ubuntu-latest
   steps:
   - name: Checkout code
     uses: actions/checkout@v3
   
   - name: Set up Python
     uses: actions/setup-python@v4
     with:
       python-version: '3.10'
   
   - name: Install dbt
     run: |
       pip install dbt-snowflake==1.9.4
   
   - name: Generate dbt manifest
     run: |
       cd dbt/snowflake_demo  # Adjust to your dbt project path
       
       # Create a minimal dummy profiles.yml
       mkdir -p ~/.dbt
       cat > ~/.dbt/profiles.yml << EOF
       snowflake_demo:
         target: dev
         outputs:
           dev:
             type: snowflake
             account: dummy
             user: dummy
             password: dummy
             role: dummy
             warehouse: dummy
             database: dummy
             schema: dummy
             threads: 4
       EOF
       
       # Generate manifest.json
       dbt deps  # Only if you have packages.yml
       dbt parse
       
       # Verify manifest was created
       ls -la target/manifest.json
   
   - name: Deploy to Astro
     uses: astronomer/deploy-action@v0.10.1
     with:
       deployment-id: ${{ vars.DEPLOYMENT_ID }}
       force: true